<!DOCTYPE HTML>
<html>
<head>
	<meta charset="UTF-8">
	<title>DNCL実行</title>
	<link href="./jquery/jquery-linedtextarea.css" type="text/css" rel="stylesheet"/>
	<link href="./dncl.css" type="text/css" rel="stylesheet"/>
	<script src="./jquery/jquery-3.1.1.min.js" type="text/javascript"></script>
	<script src="./jquery/jquery-linedtextarea.js" type="text/javascript"></script>
	<script src="./dncl.js" type="text/javascript"></script>
	<script src="./disp.js" type="text/javascript"></script>
	<script src="./run1.js"  type="text/javascript"></script>
	<script type="text/javascript">
		onload = function(){
			var sourceTextArea = document.getElementById("sourceTextarea");
			var parseTextArea = document.getElementById("parseTextarea");
			var resultTextArea = document.getElementById("resultTextarea");
//			var inputTextArea = document.getElementById("inputTextarea");
			var parseButton   = document.getElementById("parseButton");
			var runButton     = document.getElementById("runButton");
			var resetButton   = document.getElementById("resetButton");
			var stepButton    = document.getElementById("stepButton");
			var loadButton    = document.getElementById("loadButton");
			var source, parse;
			$("#sourceTextarea").linedtextarea();
			reset(resultTextArea);
			parseButton.onclick = function(){
				source = sourceTextArea.value+"\n";
				try{
					parseTextArea.value = '';
					parse = dncl.parse(source);
					parseTextArea.value = toString(parse);
				}
				catch(e){
					parseTextArea.value += "構文エラーです\n" + e.message;
				}
			};
			runButton.onclick = function(){
				source = sourceTextArea.value+"\n";
				try{
					parseTextArea.innerHTML = '';
					parse = dncl.parse(source);
//					parseTextArea.value = toString(parse);
					try{
						run(parse, false);
					}
					catch(e)
					{
						resultTextArea.value += "実行時エラーです\n" + 
						e.line + "行目:" + e.message+"\n";
					}
				}
				catch(e){
					resultTextArea.value += "構文エラーです\n" + e.message + "\n";
				}
			};
			resetButton.onclick = function(){
				reset(resultTextArea);
			};
			stepButton.onclick = function()
			{
				source = sourceTextArea.value+"\n";
				try{
					parseTextArea.innerHTML = '';
					parse = dncl.parse(source);
//					parseTextArea.value = toString(parse);
					try{
						run(parse, true);
					}
					catch(e)
					{
						resultTextArea.value += "実行時エラーです\n" + 
						e.line + "行目:" + e.message+"\n";
					}
				}
				catch(e){
					resultTextArea.value += "構文エラーです\n" + e.message + "\n";
				}
			}
			loadButton.addEventListener("change", function(ev)
			{
				let file = ev.target.files;
				let reader = new FileReader();
				reader.readAsText(file[0], "UTF-8");
				reader.onload = function(ev)
				{
					sourceTextArea.value = reader.result;
				}
			}
			,false);
			downloadLink.onclick = function()
			{
				let now = new Date();
				let filename = now.getFullYear() + ('0' + (now.getMonth() + 1)).slice(-2) +
					('0' + now.getDate()).slice(-2) + '_' + ('0' + now.getHours()).slice(-2) + 
					('0' + now.getMinutes()).slice(-2) + ('0' + now.getSeconds()).slice(-2) + 
					'.PEN';
				let blob = new Blob([sourceTextArea.value], {type:"text/plain"});
				if(window.navigator.msSaveBlob)
				{
					window.navigator.msSaveBlob(blob, filename);
				}
				else
				{
					window.URL = window.URL || window.webkitURL;
					downloadLink.setAttribute("href", window.URL.createObjectURL(blob));
					downloadLink.setAttribute("download", filename);
				}
			};
		}

	</script>
</head>
<body>
<p>配列はまだ使えない</p>
	<button   id="parseButton" type="button">Parse</button>
	<button   id="runButton" type="button">Run</button>
	<button   id="resetButton" type="button">Reset</button>
	<button   id="stepButton" type="button">Step</button><br/>
	Upload <input    id="loadButton" type="file"/><br/>
	<a href="#" id="downloadLink">Download</a><br/>
	<textarea id="sourceTextarea" rows="20" cols="50">
1+2を表示する</textarea>
	<textarea id="resultTextarea" rows="20" cols="50" readonly></textarea>
	<textarea id="parseTextarea"  rows="20" cols="50" readonly></textarea>
</body>
</html>
